<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Attendance Management - Online Attendance</title>
  <link rel="stylesheet" href="css/style.css" />
</head>
<body>
  <!-- Glassmorphic top navigation -->
  <header class="app-header">
    <div class="app-header-inner">
      <div class="brand">
        <div class="brand-icon">AMS</div>
        <div class="brand-text">
          <span class="brand-title">Attendance Management</span>
          <span class="brand-subtitle">Online Attendance</span>
        </div>
      </div>
      <nav class="nav-primary" aria-label="Primary navigation">
        <a href="index.html" class="nav-pill">
          <span class="nav-pill-icon">ğŸ”‘</span>
          <span class="nav-pill-label">Login</span>
        </a>
        <a href="dashboard.html" class="nav-pill">
          <span class="nav-pill-icon">ğŸ“Š</span>
          <span class="nav-pill-label">Dashboard</span>
        </a>
        <a href="students.html" class="nav-pill">
          <span class="nav-pill-icon">ğŸ‘¨â€ğŸ“</span>
          <span class="nav-pill-label">Students</span>
        </a>
        <a href="attendance.html" class="nav-pill active">
          <span class="nav-pill-icon">âœ…</span>
          <span class="nav-pill-label">Attendance</span>
        </a>
        <a href="reports.html" class="nav-pill">
          <span class="nav-pill-icon">ğŸ“‘</span>
          <span class="nav-pill-label">Reports</span>
        </a>
      </nav>
    </div>
  </header>

  <main class="attendance-main">
    <!-- Page header -->
    <section class="card glass attendance-header">
      <div class="attendance-header-title">
        <span class="attendance-header-icon">ğŸ“…</span>
        <div>
          <h1>Attendance Management</h1>
          <p class="attendance-header-subtitle">Create sessions and mark attendance for the selected class.</p>
        </div>
      </div>
    </section>

    <section class="attendance-grid">
      <!-- Create Session & Load Students -->
      <section class="card glass attendance-card" id="createSessionCard">
        <header class="attendance-card-header">
          <div>
            <h2><span class="attendance-card-icon">ğŸ“˜</span>Create Session &amp; Load Students</h2>
            <p class="attendance-card-subtitle">Select class, pick a date, and create a teaching session.</p>
          </div>
          <div class="attendance-card-divider"></div>
        </header>
        <form id="sessionForm" class="attendance-form">
          <label>
            <span>Class</span>
            <select id="sessionClass" required></select>
          </label>
          <label>
            <span>Date</span>
            <input type="date" id="sessionDate" required />
          </label>
          <label>
            <span>Topic</span>
            <input type="text" id="sessionTopic" />
          </label>
          <div class="attendance-card-actions">
            <button type="submit" class="btn-pill">
              <span class="btn-pill-icon">â•</span>
              <span>Create Session</span>
            </button>
          </div>
        </form>
        <p id="sessionMessage" class="message"></p>
      </section>

      <!-- Mark Attendance -->
      <section class="card glass attendance-card attendance-card-wide" id="markAttendanceCard">
        <header class="attendance-card-header">
          <div>
            <h2><span class="attendance-card-icon">âœ”ï¸</span>Mark Attendance</h2>
            <p class="attendance-card-subtitle">Mark students present or absent for this session.</p>
          </div>
          <div class="attendance-card-divider"></div>
        </header>

        <p id="attendanceInfo" class="attendance-info">No session selected.</p>

        <div class="table-wrapper glass-table">
          <table class="attendance-table">
            <thead>
              <tr>
                <th>Present</th>
                <th>Student</th>
                <th>Roll</th>
              </tr>
            </thead>
            <tbody id="attendanceTable"></tbody>
          </table>
        </div>

        <div class="attendance-card-actions attendance-save-actions">
          <button id="saveAttendance" class="btn-pill" disabled>
            <span class="btn-pill-icon">ğŸ’¾</span>
            <span>Save Attendance</span>
          </button>
        </div>
        <p id="attendanceMessage" class="message"></p>
      </section>
    </section>
  </main>

  <script>
    let currentSessionId = null;
    let currentClassId = null;

    function getAuth() {
      try {
        const raw = localStorage.getItem('auth');
        return raw ? JSON.parse(raw) : null;
      } catch (e) {
        return null;
      }
    }

    function authFetch(url, options = {}) {
      const auth = getAuth();
      if (!auth || !auth.token || !auth.user) {
        window.location.href = 'index.html';
        throw new Error('Not authenticated');
      }

      const headers = Object.assign({}, options.headers || {}, {
        'x-auth-token': auth.token
      });

      return fetch(url, Object.assign({}, options, { headers })).then(async (res) => {
        if (res.status === 401) {
          localStorage.removeItem('auth');
          window.location.href = 'index.html';
          throw new Error('Unauthorized');
        }
        if (res.status === 403) {
          alert('Access denied for this operation.');
          throw new Error('Forbidden');
        }
        return res;
      });
    }

    (function enforceRole() {
      const auth = getAuth();
      if (!auth || !auth.user) {
        window.location.href = 'index.html';
        return;
      }

      const role = auth.user.role;
      // Only teachers can access the attendance marking page
      if (role !== 'teacher') {
        alert('Only teachers can access attendance marking.');
        if (role === 'admin') {
          window.location.href = 'admin-dashboard.html';
        } else if (role === 'student') {
          window.location.href = 'student-dashboard.html';
        } else {
          window.location.href = 'index.html';
        }
        return;
      }
    })();

    async function fetchClasses() {
      const res = await authFetch('/api/classes');
      const classes = await res.json();
      return Array.isArray(classes) ? classes : [];
    }

    async function loadClasses() {
      const classes = await fetchClasses();
      const sel = document.getElementById('sessionClass');
      sel.innerHTML = '';
      classes.forEach(c => {
        const opt = document.createElement('option');
        opt.value = c.id;
        opt.textContent = c.name;
        sel.appendChild(opt);
      });
    }

    async function loadStudentsForClass(classId) {
      const res = await authFetch('/api/students?class_id=' + encodeURIComponent(classId));
      const students = await res.json();
      const tbody = document.getElementById('attendanceTable');
      tbody.innerHTML = '';
      (students || []).forEach(s => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><input type="checkbox" data-student-id="${s.id}" checked /></td>
          <td>${s.name}</td>
          <td>${s.roll_number || ''}</td>
        `;
        tbody.appendChild(tr);
      });
      document.getElementById('saveAttendance').disabled = students.length === 0;
    }

    document.getElementById('sessionForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const class_id = document.getElementById('sessionClass').value;
      const date = document.getElementById('sessionDate').value;
      const topic = document.getElementById('sessionTopic').value.trim();
      const msgEl = document.getElementById('sessionMessage');
      msgEl.textContent = '';

      try {
        const res = await authFetch('/api/sessions', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ class_id, date, topic })
        });
        const data = await res.json();
        if (!res.ok) {
          msgEl.textContent = data.error || 'Failed to create session';
          msgEl.classList.add('error');
          return;
        }
        currentSessionId = data.id;
        currentClassId = class_id;
        msgEl.textContent = 'Session created. You can now mark attendance.';
        msgEl.classList.remove('error');
        msgEl.classList.add('success');
        document.getElementById('attendanceInfo').textContent = `Session #${data.id} for class ${class_id} on ${date}`;
        await loadStudentsForClass(class_id);
      } catch (err) {
        console.error(err);
        msgEl.textContent = 'Network error';
      }
    });

    document.getElementById('saveAttendance').addEventListener('click', async () => {
      if (!currentSessionId) return;
      const checkboxes = document.querySelectorAll('input[data-student-id]');
      const records = [];
      checkboxes.forEach(cb => {
        const student_id = parseInt(cb.getAttribute('data-student-id'), 10);
        const status = cb.checked ? 'present' : 'absent';
        records.push({ student_id, status });
      });

      const msgEl = document.getElementById('attendanceMessage');
      msgEl.textContent = '';

      try {
        const res = await authFetch('/api/attendance', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ session_id: currentSessionId, records })
        });
        const data = await res.json();
        if (!res.ok) {
          msgEl.textContent = data.error || 'Failed to save attendance';
          msgEl.classList.add('error');
          return;
        }
        msgEl.textContent = 'Attendance saved successfully';
        msgEl.classList.remove('error');
        msgEl.classList.add('success');
      } catch (err) {
        console.error(err);
        msgEl.textContent = 'Network error';
      }
    });

    (async () => {
      await loadClasses();
    })();
  </script>
</body>
</html>
